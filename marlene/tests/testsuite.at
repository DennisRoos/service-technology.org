AT_INIT

# define macros to skip a test if LoLA or Fiona was not found by configure
m4_define(AT_CHECK_LOLA, [AT_CHECK([if test "LOLA" == ""; then exit 77; fi])])
m4_define(AT_CHECK_WENDY, [AT_CHECK([if test "WENDY" == ""; then exit 77; fi])])
m4_define(AT_CHECK_PETRIFY, [AT_CHECK([if test "PETRIFY" == "not_found"; then exit 77; fi])])
m4_define(AT_CHECK_GENET, [AT_CHECK([if test "GENET" == "not_found"; then exit 77; fi])])
#m4_define(AT_CHECK_FIONA, [AT_CHECK([if test "FIONA" == "not found"; then exit 77; fi])])

AT_TESTED(versions.sh)
#AT_TESTED(WENDY)
#AT_TESTED(LOLA_FULL)


############################################################################
AT_BANNER([Standard Options])
############################################################################

AT_SETUP([Help output])
AT_CHECK([MARLENE --help],0,ignore)
AT_KEYWORDS(basic)
AT_CLEANUP

AT_SETUP([Version output])
AT_CHECK([MARLENE --version],0,ignore)
AT_KEYWORDS(basic)
AT_CLEANUP

############################################################################
AT_BANNER([Small examples])
############################################################################

AT_SETUP([Small test (synchronous)])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test.owfn TESTFILES/test.ar .])
AT_CHECK([MARLENE test.owfn --rulefile=test.ar --verbose],0,ignore,ignore)
AT_KEYWORDS(sample)
AT_CLEANUP

AT_SETUP([Small test (asynchronous)])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test.owfn TESTFILES/test.ar .])
AT_CHECK([MARLENE test.owfn --rulefile=test.ar --asyncif --verbose],0,ignore,ignore)
AT_KEYWORDS(sample)
AT_CLEANUP

AT_SETUP([Small test (no complement)])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test-n.owfn TESTFILES/test-n.ar .])
AT_CHECK([MARLENE test-n.owfn --rulefile=test-n.ar --nocomplementplaces --verbose],0,ignore,ignore)
AT_KEYWORDS(sample)
AT_CLEANUP

AT_SETUP([Small test (piping)])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test-n.owfn TESTFILES/test-n.ar .])
AT_CHECK([MARLENE --rulefile=test-n.ar --nocomplementplaces --verbose < test-n.owfn > out.owfn],0,ignore,ignore)
AT_KEYWORDS(sample)
AT_CLEANUP

AT_SETUP([Small test (saving result)])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test-n.owfn TESTFILES/test-n.ar .])
AT_CHECK([MARLENE --rulefile=test-n.ar --nocomplementplaces --output=out.owfn --verbose < test-n.owfn],0,ignore,ignore)
AT_CHECK([test -f out.owfn])
AT_KEYWORDS(sample)
AT_CLEANUP

############################################################################
AT_BANNER([Special options])
############################################################################

AT_SETUP([Verbose and very verbose information])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test.owfn TESTFILES/test.ar .])
AT_CHECK([MARLENE test.owfn --rulefile=test.ar --verbose --veryverbose],0,ignore,ignore)
AT_KEYWORDS(special)
AT_CLEANUP

AT_SETUP([Do not remove temporary files])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test.owfn TESTFILES/test.ar .])
AT_CHECK([MARLENE test.owfn --rulefile=test.ar --verbose --veryverbose --noClean],0,ignore,ignore)
AT_KEYWORDS(special)
AT_CLEANUP

AT_SETUP([Bug information])
AT_CHECK([MARLENE --bug],0,,ignore)
AT_CHECK([test -f bug.log])
AT_KEYWORDS(special)
AT_CLEANUP

############################################################################
AT_BANNER([Special adapters])
############################################################################
AT_SETUP([control of rules])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca1.owfn TESTFILES/td.owfn TESTFILES/td.ar .])
AT_CHECK([MARLENE ca1.owfn td.owfn --rulefile=td.ar --verbose],0,ignore,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

AT_SETUP([chatty adapter])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca2.owfn TESTFILES/td.owfn TESTFILES/td.ar .])
AT_CHECK([MARLENE ca2.owfn td.owfn --rulefile=td.ar --asyncif --chatty --verbose],0,ignore,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

AT_SETUP([arrogant adapter])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca2.owfn TESTFILES/td.owfn TESTFILES/td.ar .])
AT_CHECK([MARLENE ca2.owfn td.owfn --rulefile=td.ar --asyncif --arrogant --verbose],0,ignore,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

AT_SETUP([engine only])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test.owfn TESTFILES/test.ar .])
AT_CHECK([MARLENE test.owfn --rulefile=test.ar --engineonly --verbose],0,ignore,ignore)
AT_KEYWORDS(sample)
AT_CLEANUP

AT_SETUP([controller only])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test.owfn TESTFILES/test.ar .])
AT_CHECK([MARLENE test.owfn --rulefile=test.ar --controlleronly --verbose],0,ignore,ignore)
AT_KEYWORDS(sample)
AT_CLEANUP

AT_SETUP([adding prefixes to nets])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca1.owfn TESTFILES/td.owfn TESTFILES/td.ar .])
AT_CHECK([MARLENE ca1.owfn td.owfn td.owfn --rulefile=td.ar --withprefix --verbose],0,ignore,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

AT_SETUP([unadaptability])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca1.owfn TESTFILES/td.owfn TESTFILES/td.ar .])
AT_CHECK([MARLENE ca1.owfn td.owfn --verbose],1,ignore,stderr)
AT_CHECK(GREP "Controller was not built" stderr,0,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

AT_SETUP([diagnosis of unadaptability])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca1.owfn TESTFILES/td.owfn TESTFILES/td.ar .])
AT_CHECK([MARLENE ca1.owfn td.owfn --diagnosis --verbose],1,ignore,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

AT_SETUP([region based conversion (Petrify) for controller])
AT_CHECK_PETRIFY
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca1.owfn TESTFILES/td.owfn TESTFILES/td.ar TESTFILES/nopetrify.conf .])
AT_CHECK([MARLENE ca1.owfn td.owfn --rulefile=td.ar --config=nopetrify.conf --messagebound=1 --verbose --sa2on=petrify],0,ignore,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

AT_SETUP([region based conversion (Genet) for controller])
AT_CHECK_GENET
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca1.owfn TESTFILES/td.owfn TESTFILES/td.ar TESTFILES/nopetrify.conf .])
AT_CHECK([MARLENE ca1.owfn td.owfn --rulefile=td.ar --config=nopetrify.conf --messagebound=1 --verbose --sa2on=gene],0,ignore,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

AT_SETUP([state machine conversion for controller])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/ca1.owfn TESTFILES/td.owfn TESTFILES/td.ar TESTFILES/nopetrify.conf .])
AT_CHECK([MARLENE ca1.owfn td.owfn --rulefile=td.ar --config=nopetrify.conf --messagebound=1 --verbose --sa2on=statemachine],0,ignore,ignore)
AT_KEYWORDS(specadapters)
AT_CLEANUP

############################################################################
AT_BANNER([Error handling])
############################################################################
AT_SETUP([wrong command line parameter])
AT_CHECK([MARLENE --wrongparameter],1,ignore,ignore)
AT_KEYWORDS(errorhandling)
AT_CLEANUP

AT_SETUP([no temporary file creation possible])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([MKDIR temptest])
AT_CHECK([chmod 400 temptest])
AT_CHECK([cp TESTFILES/ca1.owfn TESTFILES/td.owfn TESTFILES/td.ar .])
AT_CHECK([MARLENE ca1.owfn td.owfn --rulefile=td.ar --tmpfile=temptest/marlene-XXXXXX --verbose],1,ignore,ignore)
AT_KEYWORDS(errorhandling)
AT_CLEANUP

AT_SETUP([cannot write to output file])
AT_CHECK_WENDY
AT_CHECK_LOLA
AT_CHECK([MKDIR temptest])
AT_CHECK([chmod 400 temptest])
AT_CHECK([cp TESTFILES/test-n.owfn TESTFILES/test-n.ar .])
AT_CHECK([MARLENE --rulefile=test-n.ar --nocomplementplaces --output=temptest/out.owfn --verbose < test-n.owfn],1,ignore,ignore)
AT_KEYWORDS(errorhandling)
AT_CLEANUP

