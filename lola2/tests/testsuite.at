AT_INIT
AT_COLOR_TESTS

############################################################################
AT_BANNER([Basic Options])
############################################################################

AT_SETUP([Help output])
AT_CHECK([LOLA --help],0,ignore)
AT_KEYWORDS(basic)
AT_CLEANUP

AT_SETUP([Version output])
AT_CHECK([LOLA --version],0,ignore)
AT_KEYWORDS(basic)
AT_CLEANUP


############################################################################
AT_BANNER([Frontend])
############################################################################

AT_SETUP([Piping from stdin: Garavel])
AT_CHECK([cp TESTFILES/garavel.lola .])
AT_CHECK([cat garavel.lola | LOLA],0,ignore,ignore)
AT_KEYWORDS(frontend)
AT_CLEANUP

AT_SETUP([Piping from stdin: Kanban 5])
AT_CHECK([cp TESTFILES/Kanban5.pnml.lola .])
AT_CHECK([cat Kanban5.pnml.lola | LOLA],0,ignore,ignore)
AT_KEYWORDS(frontend)
AT_CLEANUP

AT_SETUP([Piping from stdin: Phils 1000])
AT_CHECK([cp TESTFILES/phils1000.lola .])
AT_CHECK([cat phils1000.lola | LOLA],0,ignore,ignore)
AT_KEYWORDS(frontend)
AT_CLEANUP


############################################################################
AT_BANNER([Reporter])
############################################################################

AT_SETUP([ReporterStream: stdout])
AT_CHECK([cp TESTFILES/garavel.lola .])
AT_CHECK([cat garavel.lola | LOLA --reporter=stream --verbose],0,stdout,stderr)
AT_CHECK([GREP -q "lola: done" stderr])
AT_KEYWORDS(reporter)
AT_CLEANUP

AT_SETUP([ReporterStream: file])
AT_CHECK([cp TESTFILES/garavel.lola .])
AT_CHECK([cat garavel.lola | LOLA --reporter=stream --verbose >& output],0)
AT_CHECK([test -f output])
AT_CHECK([GREP -q "lola: done" output])
AT_KEYWORDS(reporter)
AT_CLEANUP

AT_SETUP([ReporterSocket: sending only])
AT_CHECK([cp TESTFILES/garavel.lola .])
AT_CHECK([cat garavel.lola | LOLA --reporter=socket],0,ignore,ignore)
AT_KEYWORDS(reporter)
AT_CLEANUP

AT_SETUP([ReporterSocket: sending/receiving])
AT_CHECK([cp TESTFILES/garavel.lola .])
AT_CHECK([LISTENER > listener.log &],0)
AT_CHECK([cat garavel.lola | LOLA --reporter=socket --verbose],0,ignore,ignore)
AT_CHECK([killall listener],0,stdout,stderr)
AT_CHECK([GREP -q "lola: caught signal: 'Terminated: 15'" stderr])
AT_CHECK([GREP -q "finished parsing" listener.log])
AT_KEYWORDS(reporter)
AT_CLEANUP



############################################################################
AT_BANNER([Memory Management])
############################################################################

AT_SETUP([Checking for memory leaks: Garavel])
AT_CHECK([cp TESTFILES/garavel.lola .])
AT_CHECK([VALGRIND --leak-check=full --show-reachable=yes LOLA_RAW < garavel.lola],0,ignore,stderr)
AT_CHECK([GREP -q -E "definitely lost: 0 bytes in 0 blocks|All heap blocks were freed -- no leaks are possible" stderr])
AT_KEYWORDS(valgrind)
AT_CLEANUP

AT_SETUP([Checking for memory leaks: Phils 1000])
AT_CHECK([cp TESTFILES/phils1000.lola .])
AT_CHECK([VALGRIND --leak-check=full --show-reachable=yes LOLA_RAW < phils1000.lola],0,ignore,stderr)
AT_CHECK([GREP -q -E "definitely lost: 0 bytes in 0 blocks|All heap blocks were freed -- no leaks are possible" stderr])
AT_KEYWORDS(valgrind)
AT_CLEANUP
