AT_INIT

############################################################################
AT_BANNER([Frontend Tool "petri" Standard Options])
############################################################################

AT_SETUP([Help output])
AT_CHECK([PETRI --help],0,ignore)
AT_KEYWORDS([frontend])
AT_CLEANUP

AT_SETUP([Version output])
AT_CHECK([PETRI --version],0,ignore)
AT_KEYWORDS([frontend])
AT_CLEANUP


############################################################################
AT_BANNER([Murata Reduction Rules])
############################################################################

AT_SETUP([Removal of dead nodes])
m4_define([NET], [test_dead_nodes.net.owfn])
m4_define([RED], [dead_nodes])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 3  |P_in|= 0  |P_out|= 0  |T|= 3  |F|= 6" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 2  |P_in|= 0  |P_out|= 0  |T|= 2  |F|= 4" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Removal of identical places])
m4_define([NET], [test_identical_places.net.owfn])
m4_define([RED], [identical_places])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 12  |P_in|= 0  |P_out|= 0  |T|= 6  |F|= 22" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 11  |P_in|= 0  |P_out|= 0  |T|= 6  |F|= 16" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Removal of identical transitions])
m4_define([NET], [test_identical_transitions.net.owfn])
m4_define([RED], [identical_transitions])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 6  |P_in|= 0  |P_out|= 0  |T|= 8  |F|= 18" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 6  |P_in|= 0  |P_out|= 0  |T|= 7  |F|= 12" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Removal of self-loop places])
m4_define([NET], [test_self_loop_places.net.owfn])
m4_define([RED], [self_loop_places])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 3  |P_in|= 0  |P_out|= 0  |T|= 1  |F|= 4" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 2  |P_in|= 0  |P_out|= 0  |T|= 1  |F|= 2" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Removal of self-loop transitions])
m4_define([NET], [test_self_loop_transitions.net.owfn])
m4_define([RED], [self_loop_transitions])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 1  |P_in|= 0  |P_out|= 0  |T|= 3  |F|= 4" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 1  |P_in|= 0  |P_out|= 0  |T|= 2  |F|= 2" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Removal of serial places])
m4_define([NET], [test_series_places.net.owfn])
m4_define([RED], [series_places])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 5  |P_in|= 0  |P_out|= 0  |T|= 7  |F|= 11" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 0  |P_out|= 0  |T|= 6  |F|= 9" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Removal of serial transitions])
m4_define([NET], [test_series_transitions.net.owfn])
m4_define([RED], [series_transitions])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 5  |P_in|= 0  |P_out|= 0  |T|= 2  |F|= 6" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 0  |P_out|= 0  |T|= 1  |F|= 4" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Removal of serial transitions (keep normal)])
m4_define([NET], [test_series_transitions_keepnormal.net.owfn])
m4_define([RED], [series_transitions])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 5  |P_in|= 1  |P_out|= 1  |T|= 2  |F|= 6" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 1  |P_out|= 1  |T|= 1  |F|= 4" stderr])
AT_CHECK([PETRI NET --reduce=RED,keep_normal --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 5  |P_in|= 1  |P_out|= 1  |T|= 2  |F|= 6" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP


############################################################################
AT_BANNER([Starke Reduction Rules])
############################################################################

AT_SETUP([Starke rule 3 (places)])
m4_define([NET], [test_starke_3p.net.owfn])
m4_define([RED], [starke3p])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 2  |P_in|= 0  |P_out|= 0  |T|= 3  |F|= 6" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 1  |P_in|= 0  |P_out|= 0  |T|= 3  |F|= 3" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Starke rule 3 (transitions)])
m4_define([NET], [test_starke_3t.net.owfn])
m4_define([RED], [starke3t])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 5  |P_in|= 0  |P_out|= 0  |T|= 2  |F|= 10" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 5  |P_in|= 0  |P_out|= 0  |T|= 1  |F|= 5" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Starke rule 4])
m4_define([NET], [test_starke_4.net.owfn])
m4_define([RED], [starke4])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 0  |P_out|= 0  |T|= 4  |F|= 8" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 3  |P_in|= 0  |P_out|= 0  |T|= 3  |F|= 6" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Starke rule 5])
m4_define([NET], [test_starke_5.net.owfn])
m4_define([RED], [starke5])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 0  |P_out|= 0  |T|= 4  |F|= 9" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 3  |P_in|= 0  |P_out|= 0  |T|= 3  |F|= 7" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Starke rule 6])
m4_define([NET], [test_starke_6.net.owfn])
m4_define([RED], [starke6])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 5  |P_in|= 0  |P_out|= 0  |T|= 5  |F|= 12" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 0  |P_out|= 0  |T|= 4  |F|= 10" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Starke rule 7])
m4_define([NET], [test_starke_7.net.owfn])
m4_define([RED], [starke7])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 3  |P_in|= 0  |P_out|= 0  |T|= 2  |F|= 6" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 2  |P_in|= 0  |P_out|= 0  |T|= 1  |F|= 2" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Starke rule 8])
m4_define([NET], [test_starke_8.net.owfn])
m4_define([RED], [starke8])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 0  |P_out|= 0  |T|= 2  |F|= 10" stderr])
AT_CHECK([PETRI NET --reduce=RED --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 0  |P_out|= 0  |T|= 1  |F|= 4" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP

AT_SETUP([Starke rule 9])
m4_define([NET], [test_starke_9.net.owfn])
m4_define([RED], [starke9])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 5  |P_in|= 0  |P_out|= 0  |T|= 5  |F|= 15" stderr])
AT_CHECK([PETRI NET --reduce=RED,once --output=owfn],0,ignore,ignore)
AT_CHECK([PETRI NET.reduced.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "|P|= 4  |P_in|= 0  |P_out|= 0  |T|= 4  |F|= 12" stderr])
AT_KEYWORDS([frontend reduction])
AT_CLEANUP


############################################################################
AT_BANNER([Structural Criteria])
############################################################################

AT_SETUP([Workflow net])
m4_define([NET], [test_criteria.workflownet.owfn])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --isWorkflow],0,ignore,stderr)
AT_CHECK([GREP -q "petri:NET: 1" stderr])
AT_KEYWORDS([frontend criteria])
AT_CLEANUP

AT_SETUP([No workflow net])
m4_define([NET], [test_criteria.noworkflownet.owfn])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --isWorkflow],0,ignore,stderr)
AT_CHECK([GREP -q "petri:NET: 0" stderr])
AT_KEYWORDS([frontend criteria])
AT_CLEANUP

AT_SETUP([Free choice net])
m4_define([NET], [test_criteria.freechoice.owfn])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --isFreeChoice],0,ignore,stderr)
AT_CHECK([GREP -q "petri:NET: 1" stderr])
AT_KEYWORDS([frontend criteria])
AT_CLEANUP

AT_SETUP([No free choice net])
m4_define([NET], [test_criteria.nofreechoice.owfn])
AT_CHECK([cp TESTFILES/NET .])
AT_CHECK([PETRI NET --isFreeChoice],0,ignore,stderr)
AT_CHECK([GREP -q "petri:NET: 0" stderr])
AT_KEYWORDS([frontend criteria])
AT_CLEANUP


############################################################################
AT_BANNER([Open Net Generator])
############################################################################

AT_SETUP([Generation of 10 nets with at most 20 places])
AT_CHECK([GENERATOR 10 20],0,ignore,stderr)
AT_CHECK([wc -l stderr],0,stdout)
AT_CHECK([GREP -q "20" stdout])
AT_KEYWORDS([generator])
AT_CLEANUP

AT_SETUP([Generation of 20 nets with at most 10 places])
AT_CHECK([GENERATOR 20 10],0,ignore,stderr)
AT_CHECK([wc -l stderr],0,stdout)
AT_CHECK([GREP -q "10" stdout])
AT_KEYWORDS([generator])
AT_CLEANUP
